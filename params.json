{"name":"Redis-2.6.16-rotate-aof","tagline":"Redis AOF 日志滚动归档功能实现","body":"#Redis 2.6.16 rotate.aof 功能说明\r\n\r\n## 万恶的 AOF Rewrite\r\n\r\n###AOF rewrite 缺陷说明\r\n\r\nauto rewrite功能的引入，主要是为了解决aof文件不断增长减少重复键读写操作的日志,\r\n通过定时触发,重新根据实际内存键值情况写入新的aof文件, 再进新旧替换文件,实现aof文件最小化。\r\n\r\n然而通过测试,系统在大压力下进行auto rewrite操作【maxmomery 40gb】,导致redis服务会有6-10s的延时。\r\n该延时与设置的 maxmomery 设置值相关。maxmomery 越大延时越严重。\r\n\r\n同时auto rewrite的使用设置的 maxmomery 值越大, 还会导致COPY ON WRITE内存的分配。\r\n这就是为什么作者在安装建议中提出，需预留1倍的内存出来。在极限情况下,\r\n一个redis的实例会用去 maxmomery * 2 内存。\r\n\r\n###AOF rewrite 缺陷实测数据\r\n\r\n版本 2.6.16 中 文件的flush磁盘操作与 close操作 均已经放入 background 线程操作。\r\n但是auto rewrite操作仍然出现较长延时, 对文件操作加入debug日志发现, 以下日志 \r\n设置redis maxmomery 40gb：\r\n    \r\n    [6831] 23 Sep 11:16:26.489 * Starting automatic rewriting of AOF on 100% growth\r\n    [6831] 23 Sep 11:16:26.535 * Background append only file rewriting started by pid 7613\r\n    [6831] 23 Sep 11:16:36.879 * Background AOF buffer size: 80 MB\r\n    [6831] 23 Sep 11:16:38.254 * Background AOF buffer size: 180 MB\r\n    [6831] 23 Sep 11:16:39.910 * Background AOF buffer size: 280 MB\r\n    [6831] 23 Sep 11:16:41.752 * Background AOF buffer size: 380 MB\r\n    [6831] 23 Sep 11:16:43.350 * Background AOF buffer size: 480 MB\r\n    [6831] 23 Sep 11:16:45.067 * Background AOF buffer size: 580 MB\r\n    [6831] 23 Sep 11:16:46.726 * Background AOF buffer size: 680 MB\r\n    [6831] 23 Sep 11:16:48.562 * Background AOF buffer size: 780 MB\r\n    [6831] 23 Sep 11:16:50.342 * Background AOF buffer size: 880 MB\r\n    [6831] 23 Sep 11:16:52.015 # Background AOF buffer size: 980 MB\r\n    [6831] 23 Sep 11:16:53.763 * Background AOF buffer size: 1080 MB\r\n    [6831] 23 Sep 11:16:55.251 * Background AOF buffer size: 1180 MB\r\n    [6831] 23 Sep 11:16:56.928 * Background AOF buffer size: 1280 MB\r\n    [6831] 23 Sep 11:16:58.777 * Background AOF buffer size: 1380 MB\r\n    [6831] 23 Sep 11:17:00.468 * Background AOF buffer size: 1480 MB\r\n    [6831] 23 Sep 11:17:02.127 * Background AOF buffer size: 1580 MB\r\n    [6831] 23 Sep 11:17:03.602 * Background AOF buffer size: 1680 MB\r\n    [6831] 23 Sep 11:17:05.156 * Background AOF buffer size: 1780 MB\r\n    [6831] 23 Sep 11:17:07.040 * Background AOF buffer size: 1880 MB\r\n    [6831] 23 Sep 11:17:08.509 # Background AOF buffer size: 1980 MB\r\n    [6831] 23 Sep 11:17:10.261 * Background AOF buffer size: 2080 MB\r\n    [6831] 23 Sep 11:17:11.837 * Background AOF buffer size: 2180 MB\r\n    [6831] 23 Sep 11:17:13.293 * Background AOF buffer size: 2280 MB\r\n    [6831] 23 Sep 11:17:14.760 * Background AOF buffer size: 2380 MB\r\n    [6831] 23 Sep 11:17:16.432 * Background AOF buffer size: 2480 MB\r\n    [6831] 23 Sep 11:17:18.093 * Background AOF buffer size: 2580 MB\r\n    [6831] 23 Sep 11:17:19.561 * Background AOF buffer size: 2680 MB\r\n    [6831] 23 Sep 11:17:21.206 * Background AOF buffer size: 2780 MB\r\n    [6831] 23 Sep 11:17:22.665 * Background AOF buffer size: 2880 MB\r\n    [6831] 23 Sep 11:17:24.393 # Background AOF buffer size: 2980 MB\r\n    [6831] 23 Sep 11:17:26.582 * Background AOF buffer size: 3080 MB\r\n    [6831] 23 Sep 11:17:29.029 * Background AOF buffer size: 3180 MB\r\n    [6831] 23 Sep 11:17:31.540 * Background AOF buffer size: 3280 MB\r\n    [6831] 23 Sep 11:17:33.321 * Background AOF buffer size: 3380 MB\r\n    [6831] 23 Sep 11:17:34.782 * Background AOF buffer size: 3480 MB\r\n    [6831] 23 Sep 11:17:36.329 * Background AOF buffer size: 3580 MB\r\n    [6831] 23 Sep 11:17:38.017 * Background AOF buffer size: 3680 MB\r\n    [6831] 23 Sep 11:17:39.684 * Background AOF buffer size: 3780 MB\r\n    [6831] 23 Sep 11:17:41.352 * Background AOF buffer size: 3880 MB\r\n    [7613] 23 Sep 11:17:42.899 * SYNC append only file rewrite performed\r\n    [7613] 23 Sep 11:17:42.903 * AOF rewrite: **41858 MB** of memory used by **copy-on-write**\r\n    [6831] 23 Sep 11:17:42.984 # Background AOF buffer size: 3980 MB\r\n    [6831] 23 Sep 11:17:43.070 * Background AOF rewrite terminated with success\r\n    _[6831] 23 Sep 11:17:43.070 # Rewrite Done Parent Proc open file:temp-rewriteaof-bg-7613.aof last:100 usecs_\r\n    [6831] 23 Sep 11:17:45.491 * Parent diff successfully flushed to the rewritten AOF (4178936455 bytes)\r\n    _[6831] 23 Sep 11:17:49.401 # Rewrite Done Parent Proc rename file:temp-rewriteaof-bg-7613.aof last:3909908 usecs_\r\n    [6831] 23 Sep 11:17:49.401 * Background AOF rewrite finished successfully\r\n\r\n从日志中发现, 文件的rename操作用去了近4s, 相当与redis 4s 没有响应，通过 tcprstat 实时监控，\r\nredis无响应时间在8s左右.如果应用对实时响应要求很高，10s无响应肯定是无法接受的。\r\n\r\n##AOF rotate\r\n\r\n###目的\r\n\r\n将AOF在线实时Rewrite的功能，切换到线下操作。提升了redis性能的同时提升内存的利用率。\r\n\r\n###功能说明\r\n\r\nrotate其实是参照日志程序的功能，当aof文件达到最大值阀值时，切换aof文件，将老的aof文件重命名添加[.数字]的后缀，后续操作命令写入到新的空的aof文件中。如此循环。\r\n\r\n同时，rotate设置最大切换文件的数目，一旦超过该总数，后缀再次重0开始计数。防止硬盘写满出现异常。\r\n运维时必须尽量保证rotate不会自动重0开始计数，因为一旦从0开始循环，相当与早期的操作命令被冲掉。\r\n\r\n###功能配置\r\n\r\n####redis.conf 增加两项配置：\r\n\r\n    #文件rotate最大阀值\r\n    auto-aof-rotate-max-size  20gb\r\n\r\n    #磁盘最多存储rotate文件数 保证  \r\n    #【auto-aof-rotate-max-size * auto-aof-rotate-max-total < disk storage】\r\n    auto-aof-rotate-max-total 4\r\n\r\n####AOF rotate启用条件\r\n\r\nAOF rotate功能不是设置就会生效，必须满足以下两个条件:\r\n\r\n    appendonly 功能必须打开： 【appendonly yes】\r\n    auto rewrite功能必须关闭: 【auto-aof-rewrite-percentage 0】\r\n\r\n###实测数据\r\n\r\n根据写入debug日志，发现每次发生AOF rotate切换文件的速度是 < 45us ，基本上可以忽略不计。redis实例整体不会出现\r\n长时间的延迟。\r\n    \r\n###线下运维\r\n\r\n引入AOF rotate模式后，必然导致一个新的问题，这些切分aof文件如何合并。\r\n\r\n该版本提供一个线下合并aof文件的redis-offline服务实例工具，系统管理人员必须通过启动线下实例进行aof合并，\r\n因为在 redis-offline 实例模式下提供了 新的 **mergeaof** 的合并命令。\r\n\r\nmergeaof 命令语法:\r\n\r\n    redis-cli >: mergeaof /path/of/appendonly.aof.x\r\n\r\nmergeaof 实现说明:\r\n\r\n    mergeaof 是一个同步操作，具体操作时间与待合并aof文件相关。\r\n\r\n例如：\r\n\r\nredis实例工作目录下,出现以下切分aof文件：\r\n\r\n    appendonly.aof\r\n    appendonly.aof.0\r\n    appendonly.aof.1\r\n    appendonly.aof.2\r\n    appendonly.aof.3\r\n\r\n一旦实例发生当机或者任何突发事件，需要恢复以上数据，可以通过 **【mergeaof 命令】** 进行恢复\r\n\r\n启动一个线下实例，主要用于合并aof重写新的aof\r\n\r\n    $: redis-offline  -p 9999 【或者 $: redis-server --offline  】\r\n\r\n合并切分文件    \r\n\r\n    $: redis-cli -p 9999 mergeaof /path_of_backup/appendonly.aof.0\r\n    $: redis-cli -p 9999 mergeaof /path_of_backup/appendonly.aof.1\r\n    $: redis-cli -p 9999 mergeaof /path_of_backup/appendonly.aof.2\r\n    $: redis-cli -p 9999 mergeaof /path_of_backup/appendonly.aof.3\r\n    $: redis-cli -p 9999 mergeaof /path_of_backup/appendonly.aof\r\n\r\n线下合并后执行bgrewrite操作  \r\n\r\n    $: redis-cli -p 9999 bgrewriteaof\r\n\r\n实例目录下，生成新的 appendonly.aof 则为以上切分文件合并后的aof数据。\r\n\r\n\r\n#Redis 2.6.16 README\r\nWhere to find complete Redis documentation?\r\n-------------------------------------------\r\n\r\nThis README is just a fast \"quick start\" document. You can find more detailed\r\ndocumentation at http://redis.io\r\n\r\nBuilding Redis\r\n--------------\r\n\r\nRedis can be compiled and used on Linux, OSX, OpenBSD, NetBSD, FreeBSD.\r\nWe support big endian and little endian architectures.\r\n\r\nIt may compile on Solaris derived systems (for instance SmartOS) but our\r\nsupport for this platform is \"best effort\" and Redis is not guaranteed to\r\nwork as well as in Linux, OSX, and *BSD there.\r\n\r\nIt is as simple as:\r\n\r\n    % make\r\n\r\nYou can run a 32 bit Redis binary using:\r\n\r\n    % make 32bit\r\n\r\nAfter building Redis is a good idea to test it, using:\r\n\r\n    % make test\r\n\r\nFixing problems building 32 bit binaries\r\n---------\r\n\r\nIf after building Redis with a 32 bit target you need to rebuild it\r\nwith a 64 bit target, or the other way around, you need to perform a\r\n\"make distclean\" in the root directory of the Redis distribution.\r\n\r\nIn case of build errors when trying to build a 32 bit binary of Redis, try\r\nthe following steps:\r\n\r\n* Install the packages libc6-dev-i386 (also try g++-multilib).\r\n* Try using the following command line instead of \"make 32bit\":\r\n\r\n    make CFLAGS=\"-m32 -march=native\" LDFLAGS=\"-m32\"\r\n\r\nAllocator\r\n---------\r\n\r\nSelecting a non-default memory allocator when building Redis is done by setting\r\nthe `MALLOC` environment variable. Redis is compiled and linked against libc\r\nmalloc by default, with the exception of jemalloc being the default on Linux\r\nsystems. This default was picked because jemalloc has proven to have fewer\r\nfragmentation problems than libc malloc.\r\n\r\nTo force compiling against libc malloc, use:\r\n\r\n    % make MALLOC=libc\r\n\r\nTo compile against jemalloc on Mac OS X systems, use:\r\n\r\n    % make MALLOC=jemalloc\r\n\r\nVerbose build\r\n-------------\r\n\r\nRedis will build with a user friendly colorized output by default.\r\nIf you want to see a more verbose output use the following:\r\n\r\n    % make V=1\r\n\r\nRunning Redis\r\n-------------\r\n\r\nTo run Redis with the default configuration just type:\r\n\r\n    % cd src\r\n    % ./redis-server\r\n    \r\nIf you want to provide your redis.conf, you have to run it using an additional\r\nparameter (the path of the configuration file):\r\n\r\n    % cd src\r\n    % ./redis-server /path/to/redis.conf\r\n\r\nIt is possible to alter the Redis configuration passing parameters directly\r\nas options using the command line. Examples:\r\n\r\n    % ./redis-server --port 9999 --slaveof 127.0.0.1 6379\r\n    % ./redis-server /etc/redis/6379.conf --loglevel debug\r\n\r\nAll the options in redis.conf are also supported as options using the command\r\nline, with exactly the same name.\r\n\r\nPlaying with Redis\r\n------------------\r\n\r\nYou can use redis-cli to play with Redis. Start a redis-server instance,\r\nthen in another terminal try the following:\r\n\r\n    % cd src\r\n    % ./redis-cli\r\n    redis> ping\r\n    PONG\r\n    redis> set foo bar\r\n    OK\r\n    redis> get foo\r\n    \"bar\"\r\n    redis> incr mycounter\r\n    (integer) 1\r\n    redis> incr mycounter\r\n    (integer) 2\r\n    redis> \r\n\r\nYou can find the list of all the available commands here:\r\n\r\n    http://redis.io/commands\r\n\r\nInstalling Redis\r\n-----------------\r\n\r\nIn order to install Redis binaries into /usr/local/bin just use:\r\n\r\n    % make install\r\n\r\nYou can use \"make PREFIX=/some/other/directory install\" if you wish to use a\r\ndifferent destination.\r\n\r\nMake install will just install binaries in your system, but will not configure\r\ninit scripts and configuration files in the appropriate place. This is not\r\nneeded if you want just to play a bit with Redis, but if you are installing\r\nit the proper way for a production system, we have a script doing this\r\nfor Ubuntu and Debian systems:\r\n\r\n    % cd utils\r\n    % ./install_server\r\n\r\nThe script will ask you a few questions and will setup everything you need\r\nto run Redis properly as a background daemon that will start again on\r\nsystem reboots.\r\n\r\nYou'll be able to stop and start Redis using the script named\r\n/etc/init.d/redis_<portnumber>, for instance /etc/init.d/redis_6379.\r\n\r\nCode contributions\r\n---\r\n\r\nNote: by contributing code to the Redis project in any form, including sending\r\na pull request via Github, a code fragment or patch via private email or\r\npublic discussion groups, you agree to release your code under the terms\r\nof the BSD license that you can find in the COPYING file included in the Redis\r\nsource distribution.\r\n\r\nPlease see the CONTRIBUTING file in this source distribution for more\r\ninformation.\r\n\r\nEnjoy!\r\n","google":"UA-44836744-1","note":"Don't delete this file! It's used internally to help with page regeneration."}